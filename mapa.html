<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mapa de Alexânia - OSM</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/12.2.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.2.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore-compat.js"></script>

  <style>
    html,body { margin:0; padding:0; height:100%; }
    #map { height:100vh; width:100%; }
    .auth-box {
      position:absolute; top:10px; left:10px; z-index:1000;
      background:white; padding:10px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.2);
    }
    .auth-box input { display:block; margin-bottom:5px; padding:5px; width:180px; }
    .auth-box button { margin-top:5px; width:90px; margin-right:5px; }
    .circle-number {
      border-radius:50%; text-align:center; line-height:40px;
      width:40px; height:40px; font-size:16px; font-weight:bold;
      background-color: transparent; /* controlado via JS */
    }
  </style>
</head>
<body>
  <div class="auth-box">
    <input type="email" id="email" placeholder="Email" />
    <input type="password" id="password" placeholder="Senha" />
    <button onclick="login()">Entrar</button>
    <button onclick="logout()">Sair</button>
  </div>

  <div id="map"></div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    // CONFIG FIREBASE
    const firebaseConfig = {
      apiKey: "AIzaSyDlpsh602fayrwxPe4tffWS_iwtgOk74Pc",
      authDomain: "mapa-alexania-359ef.firebaseapp.com",
      projectId: "mapa-alexania-359ef",
      storageBucket: "mapa-alexania-359ef.appspot.com",
      messagingSenderId: "272462901295",
      appId: "1:272462901295:web:6ad7a0af873a40a3ae56da",
      measurementId: "G-LR8JCDT3LL"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // MAP
    const map = L.map('map').setView([-16.0833, -48.5000], 15);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // Lista de quadras
    const quadras = [
      { lat: -16.074919, lng: -48.499585, id: 212 },
      { lat: -16.073372, lng: -48.501120, id: 229 },
      { lat: -16.074032, lng: -48.501109, id: 222 },
      { lat: -16.074723, lng: -48.501248, id: 213 },
      { lat: -16.075352, lng: -48.501323, id: 204 },
      { lat: -16.076032, lng: -48.501366, id: 196 },
      { lat: -16.076744, lng: -48.501388, id: 188 },
      { lat: -16.077403, lng: -48.501484, id: 182 },
      { lat: -16.078073, lng: -48.501602, id: 166 },
      { lat: -16.073280, lng: -48.502536, id: 230 },
      { lat: -16.073852, lng: -48.502632, id: 223 },
      { lat: -16.074563, lng: -48.502707, id: 214 },
      { lat: -16.075228, lng: -48.502766, id: 205 },
      { lat: -16.075919, lng: -48.502836, id: 197 },
      { lat: -16.076579, lng: -48.503003, id: 189 },
      { lat: -16.077254, lng: -48.502981, id: 183 },
      { lat: -16.077970, lng: -48.503067, id: 167 },
      { lat: -16.073073, lng: -48.504038, id: 231 },
      { lat: -16.073754, lng: -48.504113, id: 224 },
      { lat: -16.074424, lng: -48.504145, id: 215 },
      { lat: -16.075084, lng: -48.504242, id: 206 },
      { lat: -16.075692, lng: -48.504360, id: 199 },
      { lat: -16.076465, lng: -48.504403, id: 190 },
      { lat: -16.077053, lng: -48.504553, id: 184 },
      { lat: -16.077754, lng: -48.504564, id: 168 },
      { lat: -16.072950, lng: -48.505218, id: 4 },
      { lat: -16.073610, lng: -48.505266, id: 3 },
      { lat: -16.074249, lng: -48.505706, id: 2 },
      { lat: -16.074883, lng: -48.505797, id: 207 },
      { lat: -16.076228, lng: -48.505931, id: 191 },
      { lat: -16.076888, lng: -48.506087, id: 185 },
      { lat: -16.077548, lng: -48.506146, id: 169 }
    ];

    // util: aplica cor no marker de forma segura (espera _icon existir)
    function applyMarkerColor(marker, color) {
      if (!marker) return;
      if (marker._icon) {
        marker._icon.style.backgroundColor = color;
        marker._icon.style.color = (color === "gray") ? "white" : "black";
      } else {
        // se ainda não foi inserido no DOM, espera evento 'add'
        marker.once('add', () => {
          if (marker._icon) {
            marker._icon.style.backgroundColor = color;
            marker._icon.style.color = (color === "gray") ? "white" : "black";
          }
        });
      }
    }

    // Salva cor no Firestore (retorna Promise)
    function saveColorToFirestore(id, color) {
      return db.collection("quadras").doc(id.toString()).set({ color: color }, { merge: true });
    }

    // Carrega quadras em tempo real e vincula clique
    quadras.forEach(location => {
      db.collection("quadras").doc(location.id.toString())
        .onSnapshot(doc => {
          const color = doc.exists && doc.data().color ? doc.data().color : "gray";

          // cria elementos na primeira vez
          if (!location.circle) {
            location.circle = L.circle([location.lat, location.lng], {
              color: color,
              fillColor: color,
              fillOpacity: 0.6,
              radius: 20
            }).addTo(map);

            const numberIcon = L.divIcon({
              className: "circle-number",
              html: location.id,
              iconSize: [40, 40],
              iconAnchor: [20, 20],
              popupAnchor: [0, -20]
            });

            location.marker = L.marker([location.lat, location.lng], { icon: numberIcon }).addTo(map);

            // clique com rollback em caso de erro
            function changeColor() {
              const user = firebase.auth().currentUser;
              if (!user) {
                alert("Faça login para interagir com o mapa.");
                return;
              }

              const uid = user.uid;
              db.collection("usuarios").doc(uid).get().then(userDoc => {
                if (userDoc.exists && userDoc.data().role === "editor") {
                  // toggle local
                  const prevColor = location.circle.options.fillColor || "gray";
                  const newColor = prevColor === "gray" ? "green" : "gray";

                  // aplica imediatamente (melhora UX)
                  location.circle.setStyle({ fillColor: newColor, color: newColor });
                  applyMarkerColor(location.marker, newColor);

                  // tenta salvar; reverte se falhar
                  saveColorToFirestore(location.id, newColor)
                    .then(() => {
                      console.log(`Gravado: quadra ${location.id} -> ${newColor}`);
                      // onSnapshot mudará a UI para a cor final (idempotente)
                    })
                    .catch(err => {
                      console.error("Erro ao salvar cor:", err);
                      // rollback visual
                      location.circle.setStyle({ fillColor: prevColor, color: prevColor });
                      applyMarkerColor(location.marker, prevColor);
                      // mostra alerta para o usuário (mais claro que apenas console)
                      alert("Não foi possível salvar a cor. Verifique as regras do Firestore e permissão. Erro: " + (err && err.message ? err.message : err));
                    });
                } else {
                  alert("Você não tem permissão para alterar as quadras.");
                }
              }).catch(err => {
                console.error("Erro ao buscar role do usuário:", err);
                alert("Erro ao verificar permissões. Veja o console.");
              });
            }

            location.circle.on("click", changeColor);
            location.marker.on("click", changeColor);
          }

          // atualiza sempre que doc mudar
          if (location.circle) {
            location.circle.setStyle({ fillColor: color, color: color });
          }
          if (location.marker) {
            applyMarkerColor(location.marker, color);
          }
        }, err => {
          console.error("onSnapshot error (quadra " + location.id + "):", err);
        });
    });

    // AUTH
    function login() {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      firebase.auth().signInWithEmailAndPassword(email, password)
        .then(() => {
          alert("Login realizado com sucesso!");
        })
        .catch(err => {
          console.error("Erro no login:", err);
          alert("Erro no login: " + (err.message || err));
        });
    }

    function logout() {
      firebase.auth().signOut()
        .then(() => {
          alert("Logout realizado com sucesso.");
        })
        .catch(err => {
          console.error("Erro no logout:", err);
          alert("Erro ao sair: " + (err.message || err));
        });
    }
  </script>
</body>
</html>
